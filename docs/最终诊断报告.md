# 预测信号重复问题 - 最终诊断报告

## 🔍 核心发现

### 模型文件大小变化时间线

**关键转折点：2024-10-08**

| 时间段 | 模型文件大小 | 预测唯一性 | 状态 |
|--------|------------|-----------|------|
| 2024-08-23 ~ 2024-09-05 | 35.9 KB - 170.0 KB | 74.5% | ✅ 正常 |
| 2024-10-08 ~ 2024-10-21 | 8.7 KB - 9.9 KB | 未知 | ❌ 异常 |
| 2024-11-18 ~ 2024-11-29 | 6.7 KB - 37.1 KB | 4.7% | ❌ 严重问题 |

### 关键对比

**pred_2024-08-23.csv（正常）**：
- 模型大小：35.9 KB
- 唯一性：74.5%
- 最常见值占比：2.3%
- 标准差：0.00174
- 分数范围：10^-3 到 10^-4

**pred_2024-11-29.csv（异常）**：
- 模型大小：9.6 KB（**缩小73%**）
- 唯一性：4.7%
- 最常见值占比：47.8%
- 标准差：0.00017
- 分数范围：10^-7（**缩小1000倍**）

## 🎯 根本原因确定

### 原因1：特征值大量重复（最根本）

**问题链条**：
1. **2024-10-08之前**：特征数据质量较好，特征值有足够区分度
2. **2024-10-08之后**：特征数据质量变差，大量NaN被填充为0
3. **即使使用rank转换**：如果很多特征值相同，rank后仍然相同
4. **模型学不到有效信号** → 模型文件变小 → 预测结果缺乏区分度

### 原因2：缺失值填充方法不当

**当前问题**：
```python
features = features.fillna(0)  # 第182行
```
- 所有NaN被填充为0
- 如果很多股票的特征都是NaN，填充后都变成0
- rank转换后，这些0仍然会得到相同的排名值

### 原因3：特征预处理方法改变

**时间线推测**：
- **2024-08-23训练时**：可能使用了全局标准化（虽然不推荐，但数据质量好时效果尚可）
- **2024-10-08之后**：改用了rank标准化，但此时数据质量已变差
- **结果**：rank标准化无法解决特征值重复的根本问题

## 📊 证据链

1. ✅ **模型文件大小突然缩小90%** → 模型学到的信息大幅减少
2. ✅ **预测分数数量级缩小1000倍** → 模型输出范围异常小
3. ✅ **唯一性从74.5%降到4.7%** → 模型区分度严重下降
4. ✅ **两个模型在同一天重新训练** → 说明是批量重训，配置可能已改变

## 🛠️ 完整解决方案

### 步骤1：改进缺失值填充（必须）

**修改 `feature/dataset_builder.py` 第182行**：

```python
# 原来的代码（有问题）：
features = features.fillna(0)

# 修改为（推荐）：
# 使用前向填充，如果还有NaN，使用截面中位数
if isinstance(features.index, pd.MultiIndex):
    # MultiIndex：按时间点分组填充
    datetime_level = features.index.names[1] if len(features.index.names) > 1 else features.index.names[0]
    features = features.groupby(level=datetime_level).transform(
        lambda x: x.fillna(x.median() if x.median() != 0 else x.mean())
    )
else:
    # 单时间点：使用中位数填充
    features = features.fillna(features.median())
```

### 步骤2：检查特征质量（必须）

**创建特征质量检查脚本**，检查：
1. 每个特征的缺失值比例
2. 每个特征的唯一值比例
3. 是否有大量相同的特征值

### 步骤3：重新训练模型（必须）

```bash
# 删除所有旧模型
Remove-Item -Path "data\models\*.txt" -Force

# 重新训练
python pipeline/run_train.py
```

### 步骤4：验证修复效果

```bash
# 重新预测
python pipeline/run_predict.py

# 检查结果
python diagnose_prediction.py
```

## ⚠️ 关键洞察

**重要发现**：
- **特征数据质量比预处理方法更重要**
- 如果特征值本身有大量重复，任何预处理方法都无法解决
- 文件2（2024-08-23）虽然可能使用了"不推荐"的方法，但因为数据质量好，效果反而更好

## 📋 预期改善

修复后预期达到文件2的水平：
- ✅ 唯一性：从 4.7% → **>70%**
- ✅ 最常见值占比：从 47.8% → **<5%**
- ✅ 预测标准差：从 0.00017 → **>0.001**
- ✅ 模型文件大小：从 9.6 KB → **>30 KB**


