# 预测信号重复问题 - 根本原因分析

## 🔍 关键发现

### 模型文件大小变化模式

从模型训练时间线分析发现：

**2024-08-23 到 2024-09-05 的模型**：
- 文件大小：35.9 KB - 170.0 KB（正常）
- 预测结果：唯一性 74.5%，标准差 0.00174（良好）

**2024-11-18 到 2024-11-29 的模型**：
- 文件大小：6.7 KB - 37.1 KB（明显变小）
- 预测结果：唯一性 4.7%，标准差 0.00017（很差）

### 关键时间点

**2024-11-18 是转折点**：
- 之前的模型：平均 100+ KB
- 之后的模型：平均 10 KB 左右
- **模型文件大小突然缩小了 90%！**

## 🎯 根本原因

### 原因1：特征预处理方法改变（最可能）

**时间线推测**：
1. **2024-08-23 训练时**：可能使用了**全局标准化**或其他方法
   - 虽然理论上不推荐，但在这个数据集上效果较好
   - 模型文件正常大小（35.9 KB）
   - 预测结果有良好区分度（唯一性74.5%）

2. **2024-11-18 之后**：改用了**rank标准化**
   - 但特征值本身有大量重复（NaN填充为0）
   - rank转换后仍然有很多相同值
   - 模型学不到有效信号 → 模型文件变小（9.6 KB）
   - 预测结果缺乏区分度（唯一性4.7%）

### 原因2：训练数据质量变化

**可能的问题**：
- 2024-11-18之后的数据可能有更多缺失值
- 大量NaN被填充为0，导致特征值重复
- 即使使用rank转换，也无法解决根本问题

### 原因3：模型训练配置变化

**可能的变化**：
- 训练后端从native改为qlib（但两个模型都是qlib）
- 模型参数改变（树数量、深度等）
- 特征数量变化

## 📊 证据链

1. **模型文件大小突然变小** → 说明模型学到的信息变少
2. **预测分数数量级变小**（10^-7 vs 10^-3）→ 说明模型输出范围变小
3. **唯一性大幅下降**（74.5% → 4.7%）→ 说明模型区分度变差
4. **两个模型在同一天训练**（2025-11-22）→ 说明是批量重新训练的

## 🛠️ 解决方案

### 方案1：检查特征数据质量（优先）

**问题**：如果特征值本身有大量重复，rank转换也无法解决

**检查方法**：
```python
# 检查预测时使用的特征数据
# 看是否有大量NaN被填充为0
# 看是否有大量相同的特征值
```

### 方案2：改进缺失值填充方法

**当前问题**：`fillna(0)` 导致大量相同值

**改进方案**：
1. 使用前向填充（forward fill）
2. 使用截面中位数填充
3. 或者直接删除缺失值过多的特征

### 方案3：重新训练，但先修复特征质量

**步骤**：
1. 检查并修复特征数据质量问题
2. 改进缺失值填充方法
3. 确保特征有足够区分度
4. 然后重新训练模型

## ⚠️ 重要发现

**关键洞察**：
- 文件2（2024-08-23）虽然使用了可能"不推荐"的方法，但效果更好
- 这说明**特征数据质量比预处理方法更重要**
- 如果特征值本身有大量重复，任何预处理方法都无法解决

## 📋 下一步行动

1. **立即检查**：预测时使用的特征数据质量
2. **改进填充**：不要简单填充为0
3. **重新训练**：在修复特征质量后重新训练
4. **对比验证**：确保新模型效果达到文件2的水平


