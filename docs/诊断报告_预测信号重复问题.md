# 预测信号重复问题 - 诊断报告

## 📊 诊断结果总结

### 当前状态
- **配置状态**: ✅ 正确（使用 rank 标准化）
- **预测信号唯一性**: ❌ 仅 4.7%（目标 >80%）
- **最常见值占比**: ❌ 47.8%（目标 <5%）
- **预测标准差**: ❌ 0.00017（目标 >0.01）

### 问题严重程度
**严重** - 299只股票中：
- 143只股票（47.8%）得到完全相同的预测分数 `5.9180839263e-07`
- 90只股票（30.1%）得到相同的预测分数 `7.8754819211e-05`
- 只有14个不同的预测值（唯一性仅4.7%）

## 🔍 根本原因分析

### 主要原因：模型与特征预处理不匹配

**问题链条**：
1. ✅ 当前配置已正确设置为 `rank` 标准化
2. ❌ 但现有模型是用**旧的特征标准化方法**训练的（可能是全局标准化）
3. ❌ 预测时虽然使用了新的特征预处理（rank标准化），但模型期望的是旧格式的特征
4. ❌ 导致模型输出异常，产生大量重复值

### 证据
- 模型文件修改时间：2025-11-22（可能是配置修改前训练的）
- 所有预测文件都显示相同的重复模式
- 唯一性比例持续在 1-5% 之间（正常应该 >80%）

## 🛠️ 解决方案

### 方案1：重新训练所有模型（推荐）

**步骤**：

1. **备份旧模型**（可选）
```bash
mkdir -p data/models_backup
cp -r data/models/* data/models_backup/
```

2. **删除旧模型**
```bash
# Windows PowerShell
Remove-Item -Path "data\models\*.txt" -Force

# 或 Linux/Mac
rm -rf data/models/*.txt
```

3. **确认配置正确**
检查 `config/pipeline.yaml`：
```yaml
feature_engineering:
  standardize_method: "rank"  # 确保是 rank
  winsorize_cross_sectional: true
```

4. **重新训练模型**
```bash
python pipeline/run_train.py
```

5. **重新预测**
```bash
python pipeline/run_predict.py
```

6. **验证结果**
```bash
python diagnose_prediction.py
```

### 方案2：快速测试（仅训练最近几周）

如果完整重训时间太长，可以先测试最近几周：

```python
# 修改 pipeline/run_train.py 中的日期范围
# 只训练最近1个月的模型进行测试
```

## 📈 预期改善

重新训练后，预期：
- ✅ 唯一性比例：从 4.7% → **>80%**
- ✅ 最常见值占比：从 47.8% → **<5%**
- ✅ 预测标准差：从 0.00017 → **>0.01**
- ✅ IC值：预期提升 20-50%

## ⚠️ 注意事项

1. **训练时间**：完整重训可能需要数小时，请确保有足够时间
2. **数据一致性**：确保训练和预测使用相同的特征预处理流程
3. **验证**：训练后务必运行诊断脚本验证效果

## 🔄 后续优化建议

1. **特征工程**：添加更多有效因子
2. **模型参数**：调整学习率、树深度等参数
3. **标签优化**：尝试不同的标签类型（excess_return, volatility_adjusted等）


